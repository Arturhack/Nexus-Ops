<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nexus Ops: The Alliance — Preview</title>
    <!-- Tailwind Play CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div id="root" class="min-h-screen p-6"></div>

    <!-- React + ReactDOM (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for in-browser JSX transform (dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App (JSX) -->
    <script type="text/babel">
      const { useState, useEffect } = React;

      function shuffle(arr) {
        return arr.slice().sort(() => Math.random() - 0.5);
      }

      function createMap(rows = 5, cols = 7) {
        const tiles = [];
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            tiles.push({
              id: `${r}-${c}`,
              row: r,
              col: c,
              explored: r === 2 && c === 3,
              enemy: null,
              objective: Math.random() < 0.06 ? { id: `obj-${r}-${c}`, title: 'Relay Node' } : null,
            });
          }
        }
        return tiles;
      }

      function initialEnemyDeck() {
        const cards = [];
        for (let i = 0; i < 10; i++) cards.push({ id: `grunt-${i}`, type: 'grunt', strength: 1 });
        for (let i = 0; i < 6; i++) cards.push({ id: `elite-${i}`, type: 'elite', strength: 2 });
        return shuffle(cards);
      }

      function NexusOpsPreview() {
        const [map, setMap] = useState(() => createMap());
        const [players, setPlayers] = useState([
          { id: 'p1', name: 'Commander', role: 'Commander', tile: '2-3', hp: 6 },
          { id: 'p2', name: 'Engineer', role: 'Engineer', tile: '2-4', hp: 5 },
          { id: 'p3', name: 'Scout', role: 'Scout', tile: '1-3', hp: 4 },
        ]);
        const [resources, setResources] = useState({ energy: 5, supplies: 4, tech: 2 });
        const [enemyDeck, setEnemyDeck] = useState(() => initialEnemyDeck());
        const [enemyDiscard, setEnemyDiscard] = useState([]);
        const [turn, setTurn] = useState(1);
        const [phase, setPhase] = useState('player');
        const [log, setLog] = useState(['Game started — explore the map and complete objectives.']);

        function drawEnemy() {
          if (enemyDeck.length === 0) {
            setEnemyDeck(shuffle(enemyDiscard));
            setEnemyDiscard([]);
            return null;
          }
          const [top, ...rest] = enemyDeck;
          setEnemyDeck(rest);
          setEnemyDiscard((d) => [top, ...d]);
          return top;
        }

        function exploreTile(id) {
          setMap((m) => m.map((t) => (t.id === id ? { ...t, explored: true } : t)));
          setLog((l) => [`Explored ${id}.`, ...l].slice(0, 50));
        }

        function movePlayer(pid, tileId) {
          setPlayers((ps) => ps.map((p) => (p.id === pid ? { ...p, tile: tileId } : p)));
          exploreTile(tileId);
          setLog((l) => [`${pid} moved to ${tileId}.`, ...l].slice(0, 50));
        }

        function attackTile(attackerId, tileId) {
          const tile = map.find((t) => t.id === tileId);
          if (!tile || !tile.enemy) return;
          const attacker = players.find((p) => p.id === attackerId);
          let damage = attacker.role === 'Commander' ? 2 : 1;
          const remaining = tile.enemy.strength - damage;
          if (remaining <= 0) {
            setMap((m) => m.map((tt) => (tt.id === tileId ? { ...tt, enemy: null } : tt)));
            setLog((l) => [`${attacker.name} eliminated enemy on ${tileId}.`, ...l].slice(0, 50));
          } else {
            setMap((m) => m.map((tt) => (tt.id === tileId ? { ...tt, enemy: { ...tt.enemy, strength: remaining } } : tt)));
            setLog((l) => [`${attacker.name} damaged enemy on ${tileId}.`, ...l].slice(0, 50));
          }
        }

        function enemyPhase() {
          setPhase('enemy');
          setTurn((t) => t + 1);
          const count = Math.min(3, 1 + Math.floor(turn / 3));
          for (let i = 0; i < count; i++) {
            const enemy = drawEnemy();
            if (!enemy) continue;
            const candidates = map.filter((x) => x.explored && !x.enemy);
            const tile = candidates.length ? candidates[Math.floor(Math.random() * candidates.length)] : map[Math.floor(Math.random() * map.length)];
            setMap((m) => m.map((tt) => (tt.id === tile.id ? { ...tt, enemy } : tt)));
            setLog((l) => [`Enemy ${enemy.type} spawned at ${tile.id}.`, ...l].slice(0, 50));
          }

          setPlayers((ps) => {
            const updated = ps.map((p) => {
              const tile = map.find((t) => t.id === p.tile);
              if (tile && tile.enemy) {
                const dmg = tile.enemy.strength;
                setLog((l) => [`${p.name} took ${dmg} damage from ${tile.enemy.type}.`, ...l].slice(0, 50));
                return { ...p, hp: p.hp - dmg };
              }
              return p;
            });
            return updated.filter((p) => p.hp > 0);
          });

          setPhase('player');
        }

        function spendResource(type, amount) {
          setResources((r) => ({ ...r, [type]: Math.max(0, r[type] - amount) }));
        }

        function buildOrRepair(pid, tileId) {
          const player = players.find((p) => p.id === pid);
          if (!player || player.role !== 'Engineer') return;
          if (resources.supplies < 1) {
            setLog((l) => ['Not enough supplies.', ...l].slice(0, 50));
            return;
          }
          spendResource('supplies', 1);
          setMap((m) => m.map((t) => (t.id === tileId ? { ...t, objective: null } : t)));
          setLog((l) => [`Engineer repaired ${tileId}.`, ...l].slice(0, 50));
        }

        function checkObjectives() {
          const remaining = map.filter((t) => t.objective).length;
          if (remaining === 0) {
            setLog((l) => ['All objectives completed! Victory!', ...l].slice(0, 50));
            setPhase('victory');
          } else {
            setLog((l) => [`Objectives remaining: ${remaining}`, ...l].slice(0, 50));
          }
        }

        useEffect(() => {
          if (players.length === 0) {
            setLog((l) => ['All players eliminated. Defeat.', ...l].slice(0, 50));
            setPhase('defeat');
          }
        }, [players]);

        return (
          <div>
            <h1 className="text-2xl font-bold mb-4">Nexus Ops: The Alliance — Preview</h1>
            <div className="grid grid-cols-3 gap-6">
              <div className="col-span-2">
                <div className="mb-3 flex items-center gap-3">
                  <div className="p-2 rounded-md bg-white">Turn: {turn}</div>
                  <div className="p-2 rounded-md bg-white">Phase: {phase}</div>
                  <button className="px-3 py-1 rounded bg-blue-600 text-white" onClick={() => phase === 'player' && enemyPhase()}>
                    End Player Phase / Enemy Phase
                  </button>
                  <button className="px-3 py-1 rounded bg-green-600 text-white" onClick={() => {
                    setMap(createMap());
                    setPlayers([
                      { id: 'p1', name: 'Commander', role: 'Commander', tile: '2-3', hp: 6 },
                      { id: 'p2', name: 'Engineer', role: 'Engineer', tile: '2-4', hp: 5 },
                      { id: 'p3', name: 'Scout', role: 'Scout', tile: '1-3', hp: 4 },
                    ]);
                    setEnemyDeck(initialEnemyDeck());
                    setEnemyDiscard([]);
                    setResources({ energy: 5, supplies: 4, tech: 2 });
                    setTurn(1);
                    setPhase('player');
                    setLog(['Game reset.']);
                  }}>
                    Reset
                  </button>
                </div>

                <div className="bg-white p-4 rounded shadow">
                  {Array.from({ length: 5 }).map((_, r) => (
                    <div key={r} className={`flex items-center ${r % 2 ? 'ml-6' : ''}`}>
                      {Array.from({ length: 7 }).map((__, c) => {
                        const tileId = `${r}-${c}`;
                        const tile = map.find((t) => t.id === tileId) || {};
                        const playerHere = players.find((p) => p.tile === tileId);
                        return (
                          <div key={tileId} className="m-1">
                            <div onClick={() => exploreTile(tileId)} className={`w-24 h-20 p-2 rounded-lg border cursor-pointer flex flex-col justify-between ${tile.explored ? 'bg-white' : 'bg-slate-200'}`}>
                              <div className="text-xs">{tileId}</div>
                              <div className="flex-1 text-sm">
                                {tile.explored ? (
                                  <>
                                    {tile.objective && <div className="text-amber-600">Objective</div>}
                                    {tile.enemy && <div className="text-red-600">Enemy: {tile.enemy.type}</div>}
                                    {playerHere && <div className="text-blue-600">{playerHere.name}</div>}
                                  </>
                                ) : (
                                  <div className="text-gray-400">Hidden</div>
                                )}
                              </div>
                              <div className="flex gap-1">
                                <button className="text-xs px-2 py-0.5 rounded bg-slate-100" onClick={() => movePlayer('p1', tileId)}>Move C</button>
                                <button className="text-xs px-2 py-0.5 rounded bg-slate-100" onClick={() => attackTile('p1', tileId)}>Attack C</button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>

                <div className="mt-4 grid grid-cols-3 gap-3">
                  <div className="p-3 bg-white rounded shadow">
                    <h3 className="font-semibold">Players</h3>
                    {players.map((p) => (
                      <div key={p.id} className="flex justify-between mt-2">
                        <div>
                          <div className="font-medium">{p.name}</div>
                          <div className="text-sm text-gray-600">{p.role} • Tile {p.tile}</div>
                        </div>
                        <div className="text-sm">HP: {p.hp}</div>
                      </div>
                    ))}
                  </div>

                  <div className="p-3 bg-white rounded shadow">
                    <h3 className="font-semibold">Resources</h3>
                    <div className="mt-2">Energy: {resources.energy}</div>
                    <div>Supplies: {resources.supplies}</div>
                    <div>Tech: {resources.tech}</div>
                  </div>

                  <div className="p-3 bg-white rounded shadow">
                    <h3 className="font-semibold">Enemy Deck</h3>
                    <div className="mt-2">Deck: {enemyDeck.length}</div>
                    <div>Discard: {enemyDiscard.length}</div>
                  </div>
                </div>
              </div>

              <div className="col-span-1">
                <div className="bg-white p-3 rounded shadow mb-3">
                  <h3 className="font-semibold mb-2">Active Objective</h3>
                  <div>Remaining objectives: {map.filter((t) => t.objective).length}</div>
                  <button className="mt-2 w-full rounded px-2 py-1 bg-emerald-600 text-white" onClick={() => checkObjectives()}>Check Objectives</button>
                </div>

                <div className="bg-white p-3 rounded shadow mb-3">
                  <h3 className="font-semibold mb-2">Quick Actions</h3>
                  <button className="w-full mb-2 rounded px-2 py-1 bg-orange-500 text-white" onClick={() => spendResource('energy', 1)}>Spend 1 Energy</button>
                  <button className="w-full mb-2 rounded px-2 py-1 bg-amber-500 text-white" onClick={() => buildOrRepair('p2', players[1]?.tile || '2-4')}>Engineer Repair (1 supplies)</button>
                  <button className="w-full rounded px-2 py-1 bg-red-500 text-white" onClick={() => {
                    const e = drawEnemy();
                    if (!e) return;
                    const tile = map[Math.floor(Math.random() * map.length)];
                    setMap((m) => m.map((tt) => (tt.id === tile.id ? { ...tt, explored: true, enemy: e } : tt)));
                    setLog((l) => [`Force-spawn ${e.type} at ${tile.id}`, ...l].slice(0, 50));
                  }}>Force Spawn</button>
                </div>

                <div className="bg-white p-3 rounded shadow">
                  <h3 className="font-semibold mb-2">Event Log</h3>
                  <div className="h-64 overflow-auto text-sm text-gray-700">
                    {log.map((line, i) => (
                      <div key={i} className="mb-1 border-b pb-1">{line}</div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            <div className="mt-6 text-sm text-gray-600">This single-file preview uses CDN React + Tailwind for easy testing. It's a lightweight starting point you can drop on GitHub Pages or open locally.</div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<NexusOpsPreview />);
    </script>
  </body>
</html>
